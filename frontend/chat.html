<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HumanTalk AI â€” Intelligent Conversation Assistant">
    <title>HumanTalk AI â€” Chat</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="app-container">
        <button class="mobile-toggle" id="menu-toggle">â˜°</button>

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">ğŸ¤–</div>
                <div class="sidebar-brand">
                    <div class="sidebar-title">HumanTalk AI</div>
                    <div class="sidebar-subtitle">Assistant</div>
                </div>
            </div>
            <ul class="nav-links">
                <li><a href="chat.html" class="active"><span class="nav-icon">ğŸ’¬</span><span
                            class="nav-label">Chat</span></a></li>
                <li><a href="dashboard.html"><span class="nav-icon">ğŸ“Š</span><span
                            class="nav-label">Dashboard</span></a></li>
                <li><a href="history.html"><span class="nav-icon">ğŸ“‹</span><span class="nav-label">History</span></a>
                </li>
                <li><a href="settings.html"><span class="nav-icon">âš™ï¸</span><span class="nav-label">Settings</span></a>
                </li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" id="logout-btn" class="btn btn-secondary"
                    style="width:100%;font-size:13px;justify-content:center;">
                    ğŸšª Sign Out
                </a>
            </div>
        </nav>

        <!-- Main -->
        <main class="main-content">
            <div class="chat-outer">

                <!-- Chat Shell -->
                <div class="chat-shell">

                    <!-- Top Bar -->
                    <div class="chat-topbar">
                        <div class="chat-topbar-avatar">ğŸ¤–</div>
                        <div class="chat-topbar-info">
                            <div class="chat-topbar-name">HumanTalk AI</div>
                            <div class="chat-topbar-status">Online â€” Ready to help</div>
                        </div>
                        <div id="emotion-chip" class="emotion-chip">ğŸ˜ Neutral</div>
                        <div class="topbar-actions">
                            <button id="escalate-btn" title="Transfer to human agent">ğŸ§‘â€ğŸ’¼ Escalate</button>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="chat-messages" id="chat-messages">
                        <div class="date-divider">Today</div>
                        <div class="msg assistant">
                            <div class="msg-avatar">ğŸ¤–</div>
                            <div class="msg-body">
                                <div class="msg-bubble">
                                    Hey there! ğŸ‘‹ I'm <strong>HumanTalk AI</strong> â€” your intelligent assistant.<br>
                                    Ask me anything: science, tech, history, math, or customer support. I'm ready! ğŸš€
                                </div>
                                <div class="msg-meta"><span>Just now</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="msg-avatar"
                            style="background:var(--grad-aurora);border-radius:var(--r-sm);font-size:13px;width:28px;height:28px;">
                            ğŸ¤–</div>
                        <span style="font-size:12px;">VoiceBot is thinking</span>
                        <div class="typing-dots"><span></span><span></span><span></span></div>
                    </div>

                    <!-- Quick Chips -->
                    <div class="quick-chips" id="quick-chips">
                        <button class="chip" data-msg="Tell me a fun fact">âœ¨ Fun Fact</button>
                        <button class="chip" data-msg="What is AI?">ğŸ¤– What is AI?</button>
                        <button class="chip" data-msg="Tell me about space">ğŸš€ Space</button>
                        <button class="chip" data-msg="What is the capital of Germany?">ğŸŒ Geography</button>
                        <button class="chip" data-msg="What is 15 multiplied by 24?">ğŸ§® Math</button>
                        <button class="chip" data-msg="Tell me about DNA">ğŸ§¬ Science</button>
                        <button class="chip" data-msg="Tell me a joke">ğŸ˜‚ Joke</button>
                        <button class="chip" data-msg="I need help with my order">ğŸ“¦ Support</button>
                    </div>

                    <!-- Input Bar -->
                    <div class="chat-input-bar">
                        <button class="mic-btn" id="mic-btn" title="Voice input">ğŸ™ï¸</button>
                        <input type="text" id="text-input" placeholder="Ask me anythingâ€¦" autocomplete="off">
                        <button id="live-toggle" title="Toggle live streaming mode" style="
                            background: linear-gradient(135deg,#6366f1,#8b5cf6);
                            color:#fff; border:none; border-radius:10px;
                            padding:0 14px; font-size:12px; font-weight:700;
                            cursor:pointer; letter-spacing:.5px; white-space:nowrap;
                            transition:opacity .2s;
                        ">âš¡ Live</button>
                        <button class="send-btn" id="send-btn" title="Send">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>

                </div><!-- /chat-shell -->
            </div><!-- /chat-outer -->
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="js/app.js"></script>
    <script>
        // â”€â”€ DEMO MODE: bypass login when running locally â”€â”€â”€â”€â”€â”€â”€
        // If no token exists, auto-set a demo token so the chat
        // page works without needing a real login/account.
        if (!localStorage.getItem('token')) {
            localStorage.setItem('token', 'demo-token');
            localStorage.setItem('user_id', 'demo-user');
            localStorage.setItem('is_admin', 'false');
        }

        // Override API.request to handle 401 gracefully in demo mode
        const _origRequest = API.request.bind(API);
        API.request = async function (path, options = {}) {
            try {
                return await _origRequest(path, options);
            } catch (err) {
                if (err.message && err.message.includes('401')) {
                    // Re-inject demo token and retry once
                    localStorage.setItem('token', 'demo-token');
                    return await _origRequest(path, options);
                }
                throw err;
            }
        };

        const chatMessages = document.getElementById('chat-messages');
        const micBtn = document.getElementById('mic-btn');
        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        const typingEl = document.getElementById('typing-indicator');
        const emotionChip = document.getElementById('emotion-chip');

        let sessionId = null;
        let liveMode = false;

        // â”€â”€ LIVE MODE TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const liveToggleBtn = document.getElementById('live-toggle');
        liveToggleBtn.addEventListener('click', () => {
            liveMode = !liveMode;
            liveToggleBtn.style.background = liveMode
                ? 'linear-gradient(135deg,#10b981,#059669)'
                : 'linear-gradient(135deg,#6366f1,#8b5cf6)';
            liveToggleBtn.textContent = liveMode ? 'âœ… Live ON' : 'âš¡ Live';
            Toast.info(liveMode ? 'ğŸŸ¢ Live streaming mode ON' : 'âšª Instant mode ON');
        });

        // â”€â”€ TEXT CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function sendMessage() {
            const message = textInput.value.trim();
            if (!message) return;
            addMsg('user', message);
            textInput.value = '';
            sendBtn.disabled = true;
            liveToggleBtn.disabled = true;
            showTyping(true);

            if (liveMode) {
                await sendStreamingMessage(message);
            } else {
                await sendInstantMessage(message);
            }

            sendBtn.disabled = false;
            liveToggleBtn.disabled = false;
            textInput.focus();
        }

        // â”€â”€ INSTANT MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function sendInstantMessage(message) {
            try {
                const res = await API.request('/api/chat/text', {
                    method: 'POST',
                    body: JSON.stringify({ message, session_id: sessionId, language: 'en' })
                });
                sessionId = res.session_id;
                const delay = Math.min(600 + res.ai_response.length * 7, 2200);
                await new Promise(r => setTimeout(r, delay));
                showTyping(false);
                addMsg('assistant', res.ai_response, res);
                updateEmotion(res.emotion, res.is_urgent);
                if (res.fraud_alert) Toast.error('âš ï¸ Suspicious content detected');
            } catch (err) {
                showTyping(false);
                addMsg('assistant', "Oops! I had a connection hiccup. Please try again. ğŸ˜…");
                Toast.error('Connection error');
            }
        }

        // â”€â”€ LIVE STREAMING MODE (SSE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function sendStreamingMessage(message) {
            showTyping(false);

            // Create an empty streaming bubble
            const wrap = document.createElement('div');
            wrap.className = 'msg assistant';
            const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            wrap.innerHTML = `
              <div class="msg-avatar">ğŸ¤–</div>
              <div class="msg-body">
                <div class="msg-bubble" id="stream-bubble"></div>
                <div class="msg-meta"><span>${timeStr}</span><span id="stream-meta"></span></div>
              </div>`;
            chatMessages.appendChild(wrap);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            const bubble = document.getElementById('stream-bubble');
            const streamMeta = document.getElementById('stream-meta');
            let fullText = '';
            let metaData = null;

            // Blinking cursor
            bubble.innerHTML = '<span class="cursor">â–‹</span>';

            try {
                const token = localStorage.getItem('token') || 'demo-token';
                const response = await fetch('http://localhost:8000/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message, session_id: sessionId, language: 'en' })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });

                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // keep incomplete last line

                    let eventType = null;
                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            eventType = line.slice(7).trim();
                        } else if (line.startsWith('data: ')) {
                            const raw = line.slice(6).trim();
                            if (!raw) continue;
                            try {
                                const parsed = JSON.parse(raw);
                                if (eventType === 'meta') {
                                    metaData = parsed;
                                    sessionId = parsed.session_id;
                                } else if (eventType === 'token') {
                                    fullText += parsed;
                                    // Render with markdown-lite + cursor
                                    const html = fullText
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                        .replace(/\n/g, '<br>');
                                    bubble.innerHTML = html + '<span class="cursor">â–‹</span>';
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                } else if (eventType === 'done') {
                                    const html = fullText
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                        .replace(/\n/g, '<br>');
                                    bubble.innerHTML = html; // remove cursor
                                    if (metaData) {
                                        updateEmotion(metaData.emotion, metaData.is_urgent);
                                        if (metaData.is_urgent) streamMeta.innerHTML += '<span class="urgent-tag">âš  Urgent</span>';
                                        if (metaData.fraud_alert) Toast.error('âš ï¸ Suspicious content detected');
                                    }
                                }
                            } catch (e) { /* ignore parse errors */ }
                        }
                    }
                }
            } catch (err) {
                bubble.innerHTML = "Oops! Streaming failed. Please try again. ğŸ˜…";
                Toast.error('Streaming error: ' + err.message);
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        textInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        // â”€â”€ QUICK CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.querySelectorAll('.chip').forEach(chip => {
            chip.addEventListener('click', () => {
                textInput.value = chip.dataset.msg;
                sendMessage();
            });
        });

        // â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const voiceChat = new VoiceChat({
            onStatusChange: () => { },
            onRecordingStart: () => {
                micBtn.classList.add('recording');
                micBtn.textContent = 'â¹ï¸';
                Toast.info('ğŸ™ï¸ Recordingâ€¦ tap again to stop');
            },
            onRecordingStop: () => {
                micBtn.classList.remove('recording');
                micBtn.textContent = 'ğŸ™ï¸';
                showTyping(true);
            },
            onTranscript: text => addMsg('user', text),
            onResponse: data => {
                showTyping(false);
                addMsg('assistant', data.ai_response, data);
                updateEmotion(data.emotion, data.is_urgent);
                if (data.audio_base64) VoiceChat.playAudioBase64(data.audio_base64);
            },
            onError: msg => { showTyping(false); Toast.error(msg); }
        });
        micBtn.addEventListener('click', () => voiceChat.toggleRecording());

        // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function addMsg(role, text, meta = null) {
            const wrap = document.createElement('div');
            wrap.className = `msg ${role}`;

            const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            let metaHtml = `<span>${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`;
            if (meta) {
                if (meta.emotion) metaHtml += `<span class="emotion-tag ${meta.emotion}">${meta.emotion.replace('_', ' ')}</span>`;
                if (meta.is_urgent) metaHtml += `<span class="urgent-tag">âš  Urgent</span>`;
            }

            wrap.innerHTML = `
      <div class="msg-avatar">${avatar}</div>
      <div class="msg-body">
        <div class="msg-bubble">${html}</div>
        <div class="msg-meta">${metaHtml}</div>
      </div>`;
            chatMessages.appendChild(wrap);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping(v) {
            typingEl.classList.toggle('vis', v);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateEmotion(emotion, isUrgent) {
            const map = {
                very_positive: ['ğŸ˜„', '#10b981'],
                positive: ['ğŸ™‚', '#34d399'],
                neutral: ['ğŸ˜', '#06b6d4'],
                negative: ['ğŸ˜Ÿ', '#f59e0b'],
                very_negative: ['ğŸ˜¢', '#f43f5e'],
            };
            const [emoji, color] = map[emotion] || map.neutral;
            emotionChip.textContent = `${emoji} ${(emotion || 'neutral').replace('_', ' ')}`;
            emotionChip.style.background = color + '18';
            emotionChip.style.color = color;
            emotionChip.style.borderColor = color + '40';
            if (isUrgent) emotionChip.textContent += ' âš ï¸';
        }

        // Escalation
        document.getElementById('escalate-btn').addEventListener('click', async () => {
            const sid = sessionId || voiceChat.sessionId;
            if (!sid) { Toast.info('Start a conversation first'); return; }
            if (confirm('Transfer this conversation to a human agent?')) {
                try {
                    await API.request('/api/escalation/', {
                        method: 'POST',
                        body: JSON.stringify({ conversation_id: sid, reason: 'User requested', priority: 'normal' })
                    });
                    Toast.success('Transferred to human agent âœ…');
                    addMsg('assistant', 'ğŸ§‘â€ğŸ’¼ A human agent has been notified and will join shortly. Thank you for your patience!');
                } catch (e) { Toast.error('Escalation failed'); }
            }
        });

        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });
        document.getElementById('logout-btn').addEventListener('click', e => { e.preventDefault(); API.logout(); });
        textInput.focus();
    </script>
</body>

</html>